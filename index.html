<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OficinaMaster - Gestão de Veículos</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Incluindo Tesseract.js para OCR -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
    <!-- Incluindo jsPDF para geração de PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --accent: #e74c3c;
            --success: #2ecc71;
            --warning: #f39c12;
            --light: #ecf0f1;
            --dark: #2c3e50;
            --gray: #7f8c8d;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f7fa;
            color: var(--dark);
            line-height: 1.6;
            overflow-x: hidden;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 15px;
        }

        header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            padding: 15px 0;
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
        }

        header::before {
            content: "";
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 60%);
            transform: rotate(30deg);
        }

        .header-content {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
            z-index: 1;
            text-align: center;
            gap: 10px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo i {
            font-size: 1.8rem;
        }

        .logo h1 {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
            width: 100%;
        }

        .stat-card {
            background: white;
            border-radius: 8px;
            padding: 12px;
            text-align: center;
            box-shadow: var(--shadow);
            font-size: 0.9rem;
        }

        .stat-number {
            font-size: 1.5rem;
            font-weight: bold;
            margin: 8px 0;
        }

        .stat-pending { color: var(--warning); border-top: 4px solid var(--warning); }
        .stat-progress { color: var(--secondary); border-top: 4px solid var(--secondary); }
        .stat-completed { color: var(--success); border-top: 4px solid var(--success); }
        .stat-delivered { color: #9b59b6; border-top: 4px solid #9b59b6; }

        .nav-tabs {
            display: flex;
            flex-direction: column;
            margin-top: 15px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: var(--shadow);
            width: 100%;
        }

        .nav-tab {
            padding: 12px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            font-weight: 600;
            font-size: 0.9rem;
        }

        .nav-tab.active {
            background: var(--secondary);
            color: white;
        }

        .nav-tab:hover:not(.active) {
            background: #f1f1f1;
        }

        .tab-content {
            display: none;
            margin-top: 15px;
            animation: fadeIn 0.5s ease;
            width: 100%;
        }

        .tab-content.active {
            display: block;
        }

        .card {
            background: white;
            border-radius: 8px;
            box-shadow: var(--shadow);
            padding: 20px;
            transition: var(--transition);
            margin-bottom: 15px;
            width: 100%;
        }

        .card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
        }

        .card.checked {
            border-left: 4px solid var(--success);
            background-color: #f8fff9;
        }

        .card-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 12px;
            border-bottom: 1px solid #eee;
        }

        .card-header i {
            font-size: 1.3rem;
            color: var(--secondary);
            margin-right: 8px;
        }

        .card-header h2 {
            font-size: 1.3rem;
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: var(--dark);
            font-size: 0.9rem;
        }

        .form-control {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 0.9rem;
            transition: var(--transition);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--secondary);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }

        .btn {
            display: inline-block;
            padding: 10px 15px;
            background-color: var(--secondary);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: var(--transition);
            text-align: center;
        }

        .btn:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
        }

        .btn-block {
            display: block;
            width: 100%;
        }

        .btn-accent {
            background-color: var(--accent);
        }

        .btn-accent:hover {
            background-color: #c0392b;
        }

        .btn-success {
            background-color: var(--success);
        }

        .btn-success:hover {
            background-color: #27ae60;
        }

        .btn-warning {
            background-color: var(--warning);
        }

        .btn-warning:hover {
            background-color: #e67e22;
        }

        .btn-purple {
            background-color: #9b59b6;
        }

        .btn-purple:hover {
            background-color: #8e44ad;
        }

        .camera-container, .image-upload {
            border: 2px dashed #ddd;
            border-radius: 5px;
            padding: 15px;
            text-align: center;
            margin-bottom: 15px;
            position: relative;
            overflow: hidden;
            width: 100%;
        }

        .camera-container video, .camera-container canvas {
            width: 100%;
            max-height: 300px;
            border-radius: 5px;
            background: #f1f1f1;
            object-fit: cover;
        }

        .camera-actions {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 12px;
        }

        .image-upload {
            cursor: pointer;
            transition: var(--transition);
        }

        .image-upload:hover {
            border-color: var(--secondary);
        }

        .image-upload i {
            font-size: 2.5rem;
            color: #ddd;
            margin-bottom: 12px;
            transition: var(--transition);
        }

        .image-upload:hover i {
            color: var(--secondary);
        }

        .image-preview {
            width: 100%;
            display: none;
            margin-top: 15px;
            border-radius: 5px;
            overflow: hidden;
            box-shadow: var(--shadow);
        }

        .image-preview img {
            width: 100%;
            height: auto;
            max-height: 300px;
            object-fit: contain;
            display: block;
        }

        .vehicles-list {
            margin-top: 15px;
            max-height: 400px;
            overflow-y: auto;
            width: 100%;
        }

        .vehicle-item {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 12px;
            border-bottom: 1px solid #eee;
            transition: var(--transition);
            width: 100%;
        }

        .vehicle-item:hover {
            background-color: #f9f9f9;
        }

        .vehicle-item.checked {
            background-color: #e8f5e9;
            border-left: 3px solid var(--success);
        }

        .vehicle-info h3 {
            font-size: 1rem;
            margin-bottom: 5px;
        }

        .vehicle-info p {
            color: #666;
            font-size: 0.85rem;
            margin-bottom: 5px;
        }

        .vehicle-status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 15px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-top: 5px;
        }

        .status-pending {
            background-color: #ffeaa7;
            color: #d35400;
        }

        .status-progress {
            background-color: #81ecec;
            color: #00cec9;
        }

        .status-completed {
            background-color: #55efc4;
            color: #00b894;
        }

        .status-delivered {
            background-color: #74b9ff;
            color: #0984e3;
        }

        .vehicle-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 10px;
            justify-content: flex-end;
        }

        .action-btn {
            background: none;
            border: none;
            color: #999;
            cursor: pointer;
            font-size: 1rem;
            transition: var(--transition);
            padding: 5px;
        }

        .action-btn:hover {
            color: var(--secondary);
        }

        .action-btn.check:hover {
            color: var(--success);
        }

        .action-btn.uncheck:hover {
            color: var(--warning;
        }

        .action-btn.delete:hover {
            color: var(--accent);
        }

        .empty-state {
            text-align: center;
            padding: 30px 0;
            color: #999;
        }

        .empty-state i {
            font-size: 2.5rem;
            margin-bottom: 12px;
        }

        .toast {
            position: fixed;
            bottom: 15px;
            right: 15px;
            left: 15px;
            background-color: var(--success);
            color: white;
            padding: 12px 20px;
            border-radius: 5px;
            box-shadow: var(--shadow);
            opacity: 0;
            transform: translateY(20px);
            transition: var(--transition);
            z-index: 1000;
            text-align: center;
            font-size: 0.9rem;
        }

        .toast.error {
            background-color: var(--accent);
        }

        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }

        .conference-mode {
            position: fixed;
            bottom: 15px;
            left: 15px;
            background: var(--success);
            color: white;
            padding: 12px 15px;
            border-radius: 40px;
            box-shadow: var(--shadow);
            z-index: 900;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }

        .conference-mode .pulse {
            width: 12px;
            height: 12px;
            background: white;
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }

        .ocr-loading {
            display: none;
            text-align: center;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 5px;
            margin-top: 10px;
            font-size: 0.9rem;
        }

        .ocr-loading i {
            color: var(--secondary);
            margin-right: 8px;
        }

        .auto-capture-info {
            text-align: center;
            padding: 8px;
            background-color: #e3f2fd;
            border-radius: 5px;
            margin-bottom: 12px;
            font-size: 0.85rem;
            color: #0d47a1;
        }

        .auto-capture-info i {
            margin-right: 5px;
        }

        .report-actions {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 15px;
            justify-content: center;
        }

        footer {
            text-align: center;
            margin-top: 40px;
            padding: 15px;
            color: #777;
            font-size: 0.85rem;
        }

        /* Adicionando estilo para a mensagem de reconhecimento */
        .recognition-feedback {
            padding: 8px;
            margin: 8px 0;
            border-radius: 5px;
            text-align: center;
            font-weight: bold;
            font-size: 0.9rem;
        }
        
        .recognition-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .recognition-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        /* Animações */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes pulse {
            0% { transform: scale(0.95); opacity: 0.7; }
            70% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(0.95); opacity: 0.7; }
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        @keyframes highlight {
            0% { background-color: #e8f5e9; }
            50% { background-color: #c8e6c9; }
            100% { background-color: #e8f5e9; }
        }

        .rotate {
            animation: rotate 1s linear infinite;
        }

        .fade-in {
            animation: fadeIn 0.5s ease forwards;
        }

        .highlight {
            animation: highlight 2s ease;
        }

        /* Responsividade para telas maiores */
        @media (min-width: 768px) {
            .container {
                padding: 20px;
            }
            
            .header-content {
                flex-direction: row;
                justify-content: space-between;
                text-align: left;
            }
            
            .stats-container {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 15px;
            }
            
            .nav-tabs {
                flex-direction: row;
            }
            
            .nav-tab {
                flex: 1;
                padding: 15px;
                font-size: 1rem;
            }
            
            .camera-actions {
                flex-direction: row;
            }
            
            .vehicle-item {
                flex-direction: row;
                align-items: center;
            }
            
            .vehicle-actions {
                margin-top: 0;
            }
            
            .report-actions {
                flex-direction: row;
            }
            
            .toast {
                left: auto;
                right: 20px;
                width: auto;
                max-width: 400px;
            }
        }

        @media (min-width: 992px) {
            .logo i {
                font-size: 2rem;
            }
            
            .logo h1 {
                font-size: 1.8rem;
            }
            
            .stat-card {
                padding: 15px;
            }
            
            .stat-number {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <i class="fas fa-tools"></i>
                    <h1>OficinaMaster</h1>
                </div>
                <p>Gestão de Veículos com Reconhecimento de Placas</p>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- Estatísticas -->
        <div class="stats-container">
            <div class="stat-card stat-pending">
                <i class="fas fa-clock"></i>
                <div class="stat-number" id="pendingCount">0</div>
                <div>Pendentes</div>
            </div>
            <div class="stat-card stat-progress">
                <i class="fas fa-tools"></i>
                <div class="stat-number" id="progressCount">0</div>
                <div>Em Andamento</div>
            </div>
            <div class="stat-card stat-completed">
                <i class="fas fa-check-circle"></i>
                <div class="stat-number" id="completedCount">0</div>
                <div>Concluídos</div>
            </div>
            <div class="stat-card stat-delivered">
                <i class="fas fa-truck"></i>
                <div class="stat-number" id="deliveredCount">0</div>
                <div>Entregues</div>
            </div>
        </div>

        <div class="nav-tabs">
            <div class="nav-tab active" data-tab="add-vehicle">
                <i class="fas fa-plus-circle"></i> Adicionar Veículo
            </div>
            <div class="nav-tab" data-tab="manage-vehicles">
                <i class="fas fa-list"></i> Gerenciar Veículos
            </div>
            <div class="nav-tab" data-tab="conference">
                <i class="fas fa-camera"></i> Modo Conferência
            </div>
        </div>

        <!-- Tab: Adicionar Veículo -->
        <div class="tab-content active" id="add-vehicle">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-camera"></i>
                    <h2>Capturar Placa</h2>
                </div>
                
                <div class="auto-capture-info">
                    <i class="fas fa-info-circle"></i> A câmera será desligada automaticamente após o reconhecimento da placa
                </div>
                
                <div class="form-group">
                    <label>Usar câmera traseira</label>
                    <div class="camera-container">
                        <video id="cameraPreview" autoplay playsinline></video>
                        <canvas id="photoCanvas" style="display: none;"></canvas>
                        <div class="camera-actions">
                            <button id="startCamera" class="btn btn-block">
                                <i class="fas fa-video"></i> Iniciar Câmera
                            </button>
                            <button id="capturePhoto" class="btn btn-accent btn-block" disabled>
                                <i class="fas fa-camera"></i> Capturar Placa
                            </button>
                        </div>
                        <div class="recognition-feedback" id="recognitionFeedback" style="display: none;"></div>
                    </div>
                </div>

                <div class="form-group">
                    <label>Ou enviar imagem da placa</label>
                    <div class="image-upload" id="plateImageUpload">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <p>Clique ou arraste uma imagem da placa aqui</p>
                        <input type="file" id="plateImage" accept="image/*" style="display: none;">
                    </div>
                    <div class="image-preview" id="imagePreview">
                        <img src="" alt="Preview da placa">
                    </div>
                </div>

                <div class="ocr-loading" id="ocrLoading">
                    <i class="fas fa-spinner rotate"></i> Processando imagem e reconhecendo placa...
                </div>

                <div class="form-group">
                    <label for="plateNumber">Número da Placa</label>
                    <input type="text" id="plateNumber" class="form-control" placeholder="Ex: ABC1D23 ou ABC1234">
                </div>

                <div class="form-group">
                    <label for="vehicleModel">Modelo do Veículo</label>
                    <input type="text" id="vehicleModel" class="form-control" placeholder="Ex: Honda Civic">
                </div>

                <div class="form-group">
                    <label for="vehicleYear">Ano do Veículo</label>
                    <input type="number" id="vehicleYear" class="form-control" placeholder="Ex: 2020" min="1900" max="2030">
                </div>

                <div class="form-group">
                    <label for="ownerName">Nome do Proprietário</label>
                    <input type="text" id="ownerName" class="form-control" placeholder="Ex: João Silva">
                </div>

                <div class="form-group">
                    <label for="serviceDescription">Descrição do Serviço</label>
                    <textarea id="serviceDescription" class="form-control" rows="3" placeholder="Descreva o serviço a ser realizado"></textarea>
                </div>

                <button id="saveVehicle" class="btn btn-block">
                    <i class="fas fa-save"></i> Salvar Veículo
                </button>
            </div>
        </div>

        <!-- Tab: Gerenciar Veículos -->
        <div class="tab-content" id="manage-vehicles">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-clipboard-list"></i>
                    <h2>Veículos na Oficina</h2>
                </div>

                <div class="vehicles-list" id="vehiclesList">
                    <!-- Os veículos serão listados aqui via JavaScript -->
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <i class="fas fa-check-circle"></i>
                    <h2>Veículos Concluídos</h2>
                </div>

                <div class="vehicles-list" id="completedVehiclesList">
                    <!-- Os veículos concluídos serão listados aqui via JavaScript -->
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <i class="fas fa-file-alt"></i>
                    <h2>Relatórios</h2>
                </div>
                
                <div class="report-actions">
                    <button id="generateTextReport" class="btn btn-success">
                        <i class="fas fa-file-alt"></i> Relatório em Texto
                    </button>
                    <button id="generatePdfReport" class="btn btn-accent">
                        <i class="fas fa-file-pdf"></i> Relatório em PDF
                    </button>
                </div>
            </div>
        </div>

        <!-- Tab: Modo Conferência -->
        <div class="tab-content" id="conference">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-video"></i>
                    <h2>Conferência de Veículos</h2>
                </div>
                
                <div class="auto-capture-info">
                    <i class="fas fa-info-circle"></i> Aponte a câmera para as placas. A conferência será feita automaticamente
                </div>
                
                <div class="form-group">
                    <label>Camera traseira para conferência</label>
                    <div class="camera-container">
                        <video id="conferenceCameraPreview" autoplay playsinline></video>
                        <div class="camera-actions">
                            <button id="startConferenceCamera" class="btn btn-block">
                                <i class="fas fa-video"></i> Iniciar Conferência
                            </button>
                            <button id="stopConferenceCamera" class="btn btn-accent btn-block" disabled>
                                <i class="fas fa-stop"></i> Parar Conferência
                            </button>
                            <button id="recheckConference" class="btn btn-warning btn-block">
                                <i class="fas fa-sync"></i> Reconferir
                            </button>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>Veículos a conferir</label>
                    <div class="vehicles-list" id="conferenceList">
                        <!-- Lista de veículos para conferência -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <div class="conference-mode" id="conferenceModeIndicator" style="display: none;">
        <div class="pulse"></div>
        <span>Modo Conferência Ativo</span>
    </div>

    <footer>
        <div class="container">
            <p>OficinaMaster &copy; 2023 - Sistema Avançado de Gestão para Oficinas</p>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Elementos do DOM
            const navTabs = document.querySelectorAll('.nav-tab');
            const tabContents = document.querySelectorAll('.tab-content');
            const plateImageUpload = document.getElementById('plateImageUpload');
            const plateImage = document.getElementById('plateImage');
            const imagePreview = document.getElementById('imagePreview');
            const plateNumber = document.getElementById('plateNumber');
            const vehicleModel = document.getElementById('vehicleModel');
            const vehicleYear = document.getElementById('vehicleYear');
            const ownerName = document.getElementById('ownerName');
            const serviceDescription = document.getElementById('serviceDescription');
            const saveVehicle = document.getElementById('saveVehicle');
            const vehiclesList = document.getElementById('vehiclesList');
            const completedVehiclesList = document.getElementById('completedVehiclesList');
            const conferenceList = document.getElementById('conferenceList');
            const toast = document.getElementById('toast');
            const ocrLoading = document.getElementById('ocrLoading');
            const generateTextReport = document.getElementById('generateTextReport');
            const generatePdfReport = document.getElementById('generatePdfReport');
            const recognitionFeedback = document.getElementById('recognitionFeedback');
            
            // Elementos da câmera
            const cameraPreview = document.getElementById('cameraPreview');
            const photoCanvas = document.getElementById('photoCanvas');
            const startCamera = document.getElementById('startCamera');
            const capturePhoto = document.getElementById('capturePhoto');
            
            // Elementos da conferência
            const conferenceCameraPreview = document.getElementById('conferenceCameraPreview');
            const startConferenceCamera = document.getElementById('startConferenceCamera');
            const stopConferenceCamera = document.getElementById('stopConferenceCamera');
            const recheckConference = document.getElementById('recheckConference');
            const conferenceModeIndicator = document.getElementById('conferenceModeIndicator');
            
            // Elementos de estatísticas
            const pendingCount = document.getElementById('pendingCount');
            const progressCount = document.getElementById('progressCount');
            const completedCount = document.getElementById('completedCount');
            const deliveredCount = document.getElementById('deliveredCount');
            
            // Variáveis de estado
            let cameraStream = null;
            let conferenceCameraStream = null;
            let conferenceInterval = null;
            let isConferenceMode = false;
            let autoCaptureInterval = null;
            let lastRecognizedPlate = '';

            // Navegação por abas
            navTabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    
                    // Ativar aba clicada
                    navTabs.forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Mostrar conteúdo correspondente
                    tabContents.forEach(content => content.classList.remove('active'));
                    document.getElementById(tabId).classList.add('active');
                    
                    // Parar câmeras ao mudar de aba (exceto se for para a conferência)
                    if (tabId !== 'conference' && conferenceCameraStream) {
                        stopConferenceCameraHandler();
                    }
                    if (tabId !== 'add-vehicle' && cameraStream) {
                        stopCameraHandler();
                    }
                });
            });

            // Inicializar a lista de veículos
            updateVehiclesList();

            // Upload de imagem
            plateImageUpload.addEventListener('click', function() {
                plateImage.click();
            });

            plateImage.addEventListener('change', function(e) {
                if (e.target.files && e.target.files[0]) {
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        imagePreview.style.display = 'block';
                        imagePreview.querySelector('img').src = e.target.result;
                        
                        // Realizar OCR na imagem
                        performOCR(e.target.result, 'upload');
                    }
                    
                    reader.readAsDataURL(e.target.files[0]);
                }
            });

            // Configuração da câmera
            startCamera.addEventListener('click', startCameraHandler);
            capturePhoto.addEventListener('click', function() {
                capturePhotoHandler().then(recognized => {
                    if (recognized) {
                        stopCameraHandler();
                    }
                });
            });

            // Conferência
            startConferenceCamera.addEventListener('click', startConferenceCameraHandler);
            stopConferenceCamera.addEventListener('click', stopConferenceCameraHandler);
            recheckConference.addEventListener('click', resetConferenceChecks);

            // Relatórios
            generateTextReport.addEventListener('click', generateTextReportHandler);
            generatePdfReport.addEventListener('click', generatePdfReportHandler);

            // Salvar veículo
            saveVehicle.addEventListener('click', function() {
                if (!plateNumber.value || !vehicleModel.value) {
                    showToast('Preencha pelo menos a placa e o modelo do veículo', 'error');
                    return;
                }

                const vehicle = {
                    id: Date.now(),
                    plate: plateNumber.value.toUpperCase(),
                    model: vehicleModel.value,
                    year: vehicleYear.value,
                    owner: ownerName.value,
                    service: serviceDescription.value,
                    date: new Date().toLocaleDateString('pt-BR'),
                    status: 'pending',
                    image: imagePreview.querySelector('img').src || '',
                    checked: false,
                    checkedAt: null,
                    lastConference: null
                };

                saveVehicleToStorage(vehicle);
                clearForm();
                updateVehiclesList();
                showToast('Veículo salvo com sucesso!');
            });

            // Funções da câmera
            function startCameraHandler() {
                // Especificar o uso da câmera traseira
                const constraints = {
                    video: {
                        facingMode: 'environment' // Força o uso da câmera traseira
                    },
                    audio: false
                };
                
                navigator.mediaDevices.getUserMedia(constraints)
                .then(function(stream) {
                    cameraStream = stream;
                    cameraPreview.srcObject = stream;
                    capturePhoto.disabled = false;
                    startCamera.disabled = true;
                    
                    // Iniciar captura automática
                    startAutoCapture();
                })
                .catch(function(error) {
                    showToast('Erro ao acessar a câmera: ' + error.message, 'error');
                    console.error('Erro ao acessar câmera:', error);
                });
            }

            function startAutoCapture() {
                if (autoCaptureInterval) {
                    clearInterval(autoCaptureInterval);
                }
                
                // Limpar feedback anterior
                recognitionFeedback.style.display = 'none';
                lastRecognizedPlate = '';
                
                autoCaptureInterval = setInterval(async function() {
                    if (cameraStream) {
                        const recognized = await capturePhotoHandler();
                        if (recognized) {
                            // Se reconheceu uma placa, parar a câmera
                            stopCameraHandler();
                            clearInterval(autoCaptureInterval);
                            autoCaptureInterval = null;
                        }
                    }
                }, 3000); // Tenta reconhecer a cada 3 segundos
            }

            async function capturePhotoHandler() {
                const context = photoCanvas.getContext('2d');
                photoCanvas.width = cameraPreview.videoWidth;
                photoCanvas.height = cameraPreview.videoHeight;
                context.drawImage(cameraPreview, 0, 0, photoCanvas.width, photoCanvas.height);
                
                // Converter para data URL e exibir preview
                const imageData = photoCanvas.toDataURL('image/png');
                imagePreview.style.display = 'block';
                imagePreview.querySelector('img').src = imageData;
                
                // Realizar OCR na imagem capturada e retornar o resultado
                return await performOCR(imageData, 'camera');
            }

            function stopCameraHandler() {
                if (cameraStream) {
                    cameraStream.getTracks().forEach(track => track.stop());
                    cameraPreview.srcObject = null;
                    cameraStream = null;
                }
                capturePhoto.disabled = true;
                startCamera.disabled = false;
                
                if (autoCaptureInterval) {
                    clearInterval(autoCaptureInterval);
                    autoCaptureInterval = null;
                }
            }

            // Funções de conferência
            function startConferenceCameraHandler() {
                // Especificar o uso da câmera traseira
                const constraints = {
                    video: {
                        facingMode: 'environment' // Força o uso da câmera traseira
                    },
                    audio: false
                };
                
                navigator.mediaDevices.getUserMedia(constraints)
                .then(function(stream) {
                    conferenceCameraStream = stream;
                    conferenceCameraPreview.srcObject = stream;
                    startConferenceCamera.disabled = true;
                    stopConferenceCamera.disabled = false;
                    conferenceModeIndicator.style.display = 'flex';
                    isConferenceMode = true;
                    
                    // Iniciar verificação periódica
                    conferenceInterval = setInterval(checkPlateConference, 3000);
                })
                .catch(function(error) {
                    showToast('Erro ao acessar a câmera: ' + error.message, 'error');
                    console.error('Erro ao acessar câmera:', error);
                });
            }

            function stopConferenceCameraHandler() {
                if (conferenceCameraStream) {
                    conferenceCameraStream.getTracks().forEach(track => track.stop());
                    conferenceCameraPreview.srcObject = null;
                    conferenceCameraStream = null;
                }
                startConferenceCamera.disabled = false;
                stopConferenceCamera.disabled = true;
                conferenceModeIndicator.style.display = 'none';
                isConferenceMode = false;
                
                // Parar verificação periódica
                if (conferenceInterval) {
                    clearInterval(conferenceInterval);
                    conferenceInterval = null;
                }
            }

            function resetConferenceChecks() {
                const vehicles = JSON.parse(localStorage.getItem('workshopVehicles')) || [];
                const updatedVehicles = vehicles.map(vehicle => {
                    if (vehicle.status !== 'completed' && vehicle.status !== 'delivered') {
                        vehicle.checked = false;
                        vehicle.checkedAt = null;
                    }
                    return vehicle;
                });
                
                localStorage.setItem('workshopVehicles', JSON.stringify(updatedVehicles));
                updateConferenceList();
                showToast('Verificações resetadas. Todos os veículos podem ser reconferidos.');
            }

            function checkPlateConference() {
                const context = photoCanvas.getContext('2d');
                photoCanvas.width = conferenceCameraPreview.videoWidth;
                photoCanvas.height = conferenceCameraPreview.videoHeight;
                context.drawImage(conferenceCameraPreview, 0, 0, photoCanvas.width, photoCanvas.height);
                
                // Aplicar pré-processamento para melhorar o OCR
                const processedImageData = preprocessImageForOCR(context, photoCanvas.width, photoCanvas.height);
                context.putImageData(processedImageData, 0, 0);
                
                // Recortar a parte inferior da imagem para evitar a tarja
                const croppedImageData = cropLowerPart(context, photoCanvas.width, photoCanvas.height);
                context.putImageData(croppedImageData, 0, 0);
                
                // Converter para data URL e realizar OCR
                const imageData = photoCanvas.toDataURL('image/png');
                
                Tesseract.recognize(
                    imageData,
                    'eng',
                    { 
                        logger: message => console.log(message),
                        tessedit_pageseg_mode: '7',
                        tessedit_char_whitelist: 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'
                    }
                ).then(({ data: { text } }) => {
                    const foundPlate = extractPlateFromText(text);
                    if (foundPlate && foundPlate !== lastRecognizedPlate) {
                        lastRecognizedPlate = foundPlate;
                        // Verificar se a placa está na lista
                        checkIfPlateExists(foundPlate);
                    }
                });
            }

            function extractPlateFromText(text) {
                // Remover a palavra "BRASIL" e variações em qualquer lugar do texto
                text = text.replace(/\bBRASIL\b/gi, '');
                text = text.replace(/\bBRAZIL\b/gi, '');
                text = text.replace(/\bBR\b/gi, '');
                
                // Remover siglas de estados (UF) com 2 letras no início seguido de espaço ou fim
                text = text.replace(/\b[A-Z]{2}\b/g, '');
                
                // Primeiro, vamos encontrar todas as sequências de 3 letras seguidas
                const threeLettersRegex = /[A-Z]{3}/g;
                const threeLettersMatches = text.match(threeLettersRegex);
                
                if (!threeLettersMatches) return null;
                
                // Para cada sequência de 3 letras, vamos verificar se há números após ela
                for (const letters of threeLettersMatches) {
                    const lettersIndex = text.indexOf(letters);
                    const afterLetters = text.substring(lettersIndex + 3);
                    
                    // Procurar por padrões de números após as 3 letras
                    // Padrão Mercosul: 1 número + 1 letra + 2 números (ex: ABC1D23)
                    const mercosulPattern = /[0-9][A-Z][0-9]{2}/;
                    const mercosulMatch = afterLetters.match(mercosulPattern);
                    
                    if (mercosulMatch) {
                        const potentialPlate = letters + mercosulMatch[0];
                        // Verificar se a placa tem o formato correto
                        if (isValidPlate(potentialPlate)) {
                            return potentialPlate;
                        }
                    }
                    
                    // Padrão antigo: 4 números (ex: ABC1234)
                    const oldPattern = /[0-9]{4}/;
                    const oldMatch = afterLetters.match(oldPattern);
                    
                    if (oldMatch) {
                        const potentialPlate = letters + oldMatch[0];
                        // Verificar se a placa tem o formato correto
                        if (isValidPlate(potentialPlate)) {
                            return potentialPlate;
                        }
                    }
                }
                
                return null;
            }

            // Função para validar o formato da placa
            function isValidPlate(plate) {
                // Verificar formato Mercosul: 3 letras + 1 número + 1 letra + 2 números
                const mercosulPattern = /^[A-Z]{3}[0-9][A-Z][0-9]{2}$/;
                
                // Verificar formato antigo: 3 letras + 4 números
                const oldPattern = /^[A-Z]{3}[0-9]{4}$/;
                
                return mercosulPattern.test(plate) || oldPattern.test(plate);
            }

            function checkIfPlateExists(plate) {
                const vehicles = JSON.parse(localStorage.getItem('workshopVehicles')) || [];
                const vehicle = vehicles.find(v => v.plate === plate);
                
                if (vehicle) {
                    showToast(`Veículo encontrado: ${plate}`, 'success');
                    markVehicleAsChecked(vehicle.id);
                }
            }

            function markVehicleAsChecked(vehicleId) {
                const vehicles = JSON.parse(localStorage.getItem('workshopVehicles')) || [];
                const vehicleIndex = vehicles.findIndex(v => v.id === vehicleId);
                
                if (vehicleIndex !== -1) {
                    const vehicle = vehicles[vehicleIndex];
                    vehicle.checked = true;
                    vehicle.checkedAt = new Date().toLocaleString('pt-BR');
                    vehicle.lastConference = new Date().toLocaleString('pt-BR');
                    
                    localStorage.setItem('workshopVehicles', JSON.stringify(vehicles));
                    updateConferenceList();
                    
                    // Destacar visualmente o item conferido
                    const vehicleElement = document.querySelector(`.vehicle-item[data-id="${vehicleId}"]`);
                    if (vehicleElement) {
                        vehicleElement.classList.add('checked');
                        vehicleElement.classList.add('highlight');
                        
                        // Remover o destaque após a animação
                        setTimeout(() => {
                            vehicleElement.classList.remove('highlight');
                        }, 2000);
                    }
                }
            }

            // Funções OCR
            async function performOCR(imageData, source) {
                showToast('Processando imagem...');
                ocrLoading.style.display = 'block';
                
                return new Promise((resolve) => {
                    // Criar uma imagem para pré-processamento
                    const img = new Image();
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        canvas.width = img.width;
                        canvas.height = img.height;
                        
                        // Desenhar a imagem no canvas
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        
                        // Aplicar pré-processamento para melhorar o OCR
                        const processedImageData = preprocessImageForOCR(ctx, canvas.width, canvas.height);
                        ctx.putImageData(processedImageData, 0, 0);
                        
                        // Recortar a parte inferior da imagem (onde geralmente está a placa)
                        const croppedImageData = cropLowerPart(ctx, canvas.width, canvas.height);
                        ctx.putImageData(croppedImageData, 0, 0);
                        
                        // Converter para data URL
                        const processedImage = canvas.toDataURL('image/png');
                        
                        Tesseract.recognize(
                            processedImage,
                            'eng',
                            { 
                                logger: message => console.log(message),
                                // Configurar parâmetros para melhor reconhecimento de placas
                                tessedit_pageseg_mode: '7', // Modo de segmentação única de linha
                                tessedit_char_whitelist: 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789' // Só letras e números
                            }
                        ).then(({ data: { text } }) => {
                            const foundPlate = extractPlateFromText(text);
                            if (foundPlate && foundPlate !== lastRecognizedPlate) {
                                lastRecognizedPlate = foundPlate;
                                plateNumber.value = foundPlate;
                                showToast(`Placa reconhecida: ${foundPlate}`);
                                
                                // Mostrar feedback visual
                                recognitionFeedback.textContent = `Placa reconhecida: ${foundPlate}`;
                                recognitionFeedback.className = 'recognition-feedback recognition-success';
                                recognitionFeedback.style.display = 'block';
                                
                                // Se veio da câmera, parar a câmera automaticamente
                                if (source === 'camera') {
                                    stopCameraHandler();
                                }
                                
                                ocrLoading.style.display = 'none';
                                resolve(true); // Reconheceu uma placa
                            } else {
                                showToast('Não foi possível identificar a placa. Tente novamente.', 'error');
                                
                                // Mostrar feedback visual
                                recognitionFeedback.textContent = 'Placa não identificada. Tente novamente.';
                                recognitionFeedback.className = 'recognition-feedback recognition-error';
                                recognitionFeedback.style.display = 'block';
                                
                                ocrLoading.style.display = 'none';
                                resolve(false); // Não reconheceu uma placa
                            }
                        }).catch(error => {
                            showToast('Erro no reconhecimento de texto: ' + error.message, 'error');
                            ocrLoading.style.display = 'none';
                            resolve(false); // Não reconheceu uma placa
                        });
                    };
                    img.src = imageData;
                });
            }

            // Nova função para recortar a parte inferior da imagem (onde geralmente está a placa)
            function cropLowerPart(ctx, width, height) {
                // Recortar apenas a parte inferior (60% da altura) para evitar a tarja superior
                const cropHeight = height * 0.6;
                const cropY = height * 0.4;
                
                const imageData = ctx.getImageData(0, cropY, width, cropHeight);
                
                // Criar um novo canvas com a área recortada
                const croppedCanvas = document.createElement('canvas');
                croppedCanvas.width = width;
                croppedCanvas.height = cropHeight;
                const croppedCtx = croppedCanvas.getContext('2d');
                croppedCtx.putImageData(imageData, 0, 0);
                
                return croppedCtx.getImageData(0, 0, width, cropHeight);
            }

            // Pré-processamento de imagem para melhorar o OCR
            function preprocessImageForOCR(ctx, width, height) {
                const imageData = ctx.getImageData(0, 0, width, height);
                const data = imageData.data;
                
                // 1. Converter para escala de cinza
                for (let i = 0; i < data.length; i += 4) {
                    const avg = (data[i] + data[i + 1] + data[i + 2]) / 3;
                    data[i] = avg;     // R
                    data[i + 1] = avg; // G
                    data[i + 2] = avg; // B
                }
                
                // 2. Aplicar filtro de contraste
                const contrast = 1.8; // Aumentar o contraste
                for (let i = 0; i < data.length; i += 4) {
                    // Fórmula de ajuste de contraste
                    data[i] = clamp((data[i] - 128) * contrast + 128);     // R
                    data[i + 1] = clamp((data[i + 1] - 128) * contrast + 128); // G
                    data[i + 2] = clamp((data[i + 2] - 128) * contrast + 128); // B
                }
                
                // 3. Aplicar limiarização adaptativa (simplificada)
                const threshold = calculateAdaptiveThreshold(data, width, height);
                for (let i = 0; i < data.length; i += 4) {
                    const avg = (data[i] + data[i + 1] + data[i + 2]) / 3;
                    const value = avg > threshold ? 255 : 0;
                    data[i] = value;     // R
                    data[i + 1] = value; // G
                    data[i + 2] = value; // B
                }
                
                return imageData;
            }
            
            function clamp(value) {
                return Math.max(0, Math.min(255, value));
            }

            // Função para calcular limiar adaptativo (método simplificado)
            function calculateAdaptiveThreshold(data, width, height) {
                // Calcular histograma
                const histogram = new Array(256).fill(0);
                for (let i = 0; i < data.length; i += 4) {
                    const intensity = Math.round((data[i] + data[i + 1] + data[i + 2]) / 3);
                    histogram[intensity]++;
                }
                
                // Método de Otsu simplificado para encontrar o melhor limiar
                let total = width * height;
                let sum = 0;
                for (let i = 0; i < 256; i++) {
                    sum += i * histogram[i];
                }
                
                let sumB = 0;
                let wB = 0;
                let wF = 0;
                let maxVariance = 0;
                let threshold = 0;
                
                for (let i = 0; i < 256; i++) {
                    wB += histogram[i];
                    if (wB === 0) continue;
                    
                    wF = total - wB;
                    if (wF === 0) break;
                    
                    sumB += i * histogram[i];
                    
                    let mB = sumB / wB;
                    let mF = (sum - sumB) / wF;
                    
                    let variance = wB * wF * (mB - mF) * (mB - mF);
                    if (variance > maxVariance) {
                        maxVariance = variance;
                        threshold = i;
                    }
                }
                
                return threshold;
            }

            // Funções de gerenciamento de veículos
            function saveVehicleToStorage(vehicle) {
                let vehicles = JSON.parse(localStorage.getItem('workshopVehicles')) || [];
                vehicles.push(vehicle);
                localStorage.setItem('workshopVehicles', JSON.stringify(vehicles));
            }

            function clearForm() {
                plateNumber.value = '';
                vehicleModel.value = '';
                vehicleYear.value = '';
                ownerName.value = '';
                serviceDescription.value = '';
                imagePreview.style.display = 'none';
                plateImage.value = '';
                recognitionFeedback.style.display = 'none';
            }

            function updateVehiclesList() {
                const vehicles = JSON.parse(localStorage.getItem('workshopVehicles')) || [];
                const pendingVehicles = vehicles.filter(v => v.status !== 'completed' && v.status !== 'delivered');
                const completedVehicles = vehicles.filter(v => v.status === 'completed' || v.status === 'delivered');
                
                // Atualizar estatísticas
                updateStats(vehicles);
                
                // Veículos pendentes
                if (pendingVehicles.length === 0) {
                    vehiclesList.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-car"></i>
                            <p>Nenhum veículo na oficina</p>
                        </div>
                    `;
                } else {
                    vehiclesList.innerHTML = '';
                    pendingVehicles.forEach(vehicle => {
                        const vehicleItem = createVehicleItem(vehicle);
                        vehiclesList.appendChild(vehicleItem);
                    });
                }
                
                // Veículos concluídos
                if (completedVehicles.length === 0) {
                    completedVehiclesList.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-check-circle"></i>
                            <p>Nenhum veículo concluído</p>
                        </div>
                    `;
                } else {
                    completedVehiclesList.innerHTML = '';
                    completedVehicles.forEach(vehicle => {
                        const vehicleItem = createVehicleItem(vehicle);
                        completedVehiclesList.appendChild(vehicleItem);
                    });
                }
                
                updateConferenceList();
            }
            
            function updateStats(vehicles) {
                const pending = vehicles.filter(v => v.status === 'pending').length;
                const progress = vehicles.filter(v => v.status === 'progress').length;
                const completed = vehicles.filter(v => v.status === 'completed').length;
                const delivered = vehicles.filter(v => v.status === 'delivered').length;
                
                pendingCount.textContent = pending;
                progressCount.textContent = progress;
                completedCount.textContent = completed;
                deliveredCount.textContent = delivered;
            }
            
            function updateConferenceList() {
                const vehicles = JSON.parse(localStorage.getItem('workshopVehicles')) || [];
                const pendingVehicles = vehicles.filter(v => v.status !== 'completed' && v.status !== 'delivered');
                
                conferenceList.innerHTML = '';
                
                if (pendingVehicles.length === 0) {
                    conferenceList.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-car"></i>
                            <p>Nenhum veículo para conferir</p>
                        </div>
                    `;
                    return;
                }
                
                pendingVehicles.forEach(vehicle => {
                    const conferenceItem = document.createElement('div');
                    conferenceItem.className = `vehicle-item ${vehicle.checked ? 'checked' : ''}`;
                    conferenceItem.setAttribute('data-id', vehicle.id);
                    conferenceItem.innerHTML = `
                        <div class="vehicle-info">
                            <h3>${vehicle.plate} - ${vehicle.model}</h3>
                            <p>Proprietário: ${vehicle.owner || 'Não informado'} | Ano: ${vehicle.year || 'N/I'}</p>
                            <p>Serviço: ${vehicle.service || 'Não especificado'}</p>
                            <span class="vehicle-status status-${vehicle.status}">
                                ${getStatusText(vehicle.status)}
                            </span>
                            ${vehicle.checked ? `<p>Conferido em: ${vehicle.checkedAt}</p>` : ''}
                            ${vehicle.lastConference ? `<p>Última conferência: ${vehicle.lastConference}</p>` : ''}
                        </div>
                        <div class="vehicle-actions">
                            ${!vehicle.checked ? `
                            <button class="action-btn check" data-id="${vehicle.id}" title="Marcar como conferido">
                                <i class="fas fa-check-circle"></i>
                            </button>
                            ` : `
                            <button class="action-btn uncheck" data-id="${vehicle.id}" title="Desmarcar conferência">
                                <i class="fas fa-times-circle"></i>
                            </button>
                            `}
                        </div>
                    `;
                    conferenceList.appendChild(conferenceItem);
                });
                
                // Adicionar event listeners para os botões de check
                document.querySelectorAll('.action-btn.check').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const id = parseInt(this.getAttribute('data-id'));
                        markVehicleAsChecked(id);
                    });
                });
                
                // Adicionar event listeners para os botões de uncheck
                document.querySelectorAll('.action-btn.uncheck').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const id = parseInt(this.getAttribute('data-id'));
                        uncheckVehicle(id);
                    });
                });
            }

            function uncheckVehicle(id) {
                const vehicles = JSON.parse(localStorage.getItem('workshopVehicles')) || [];
                const vehicleIndex = vehicles.findIndex(v => v.id === id);
                
                if (vehicleIndex !== -1) {
                    const vehicle = vehicles[vehicleIndex];
                    vehicle.checked = false;
                    vehicle.checkedAt = null;
                    
                    localStorage.setItem('workshopVehicles', JSON.stringify(vehicles));
                    updateConferenceList();
                    showToast('Verificação removida com sucesso!');
                }
            }

            function createVehicleItem(vehicle) {
                const vehicleItem = document.createElement('div');
                vehicleItem.className = 'vehicle-item fade-in';
                vehicleItem.innerHTML = `
                    <div class="vehicle-info">
                        <h3>${vehicle.plate} - ${vehicle.model}</h3>
                        <p>Proprietário: ${vehicle.owner || 'Não informado'} | Ano: ${vehicle.year || 'N/I'}</p>
                        <p>Serviço: ${vehicle.service || 'Não especificado'}</p>
                        <p>Entrada: ${vehicle.date}</p>
                        <span class="vehicle-status status-${vehicle.status}">
                            ${getStatusText(vehicle.status)}
                        </span>
                    </div>
                    <div class="vehicle-actions">
                        <select class="status-select" data-id="${vehicle.id}">
                            <option value="pending" ${vehicle.status === 'pending' ? 'selected' : ''}>Pendente</option>
                            <option value="progress" ${vehicle.status === 'progress' ? 'selected' : ''}>Em Andamento</option>
                            <option value="completed" ${vehicle.status === 'completed' ? 'selected' : ''}>Concluído</option>
                            <option value="delivered" ${vehicle.status === 'delivered' ? 'selected' : ''}>Entregue</option>
                        </select>
                        <button class="action-btn delete" data-id="${vehicle.id}" title="Excluir veículo">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                
                // Adicionar event listeners
                const statusSelect = vehicleItem.querySelector('.status-select');
                statusSelect.addEventListener('change', function() {
                    const id = parseInt(this.getAttribute('data-id'));
                    updateVehicleStatus(id, this.value);
                });
                
                const deleteBtn = vehicleItem.querySelector('.action-btn.delete');
                deleteBtn.addEventListener('click', function() {
                    const id = parseInt(this.getAttribute('data-id'));
                    deleteVehicle(id);
                });
                
                return vehicleItem;
            }

            function getStatusText(status) {
                const statusTexts = {
                    'pending': 'Pendente',
                    'progress': 'Em Andamento',
                    'completed': 'Concluído',
                    'delivered': 'Entregue'
                };
                return statusTexts[status] || 'Desconhecido';
            }

            function updateVehicleStatus(id, status) {
                let vehicles = JSON.parse(localStorage.getItem('workshopVehicles')) || [];
                vehicles = vehicles.map(vehicle => {
                    if (vehicle.id === id) {
                        vehicle.status = status;
                        if (status === 'delivered') {
                            vehicle.deliveryDate = new Date().toLocaleDateString('pt-BR');
                        }
                    }
                    return vehicle;
                });
                localStorage.setItem('workshopVehicles', JSON.stringify(vehicles));
                updateVehiclesList();
                showToast('Status atualizado com sucesso!');
            }

            function deleteVehicle(id) {
                if (confirm('Tem certeza que deseja excluir este veículo?')) {
                    let vehicles = JSON.parse(localStorage.getItem('workshopVehicles')) || [];
                    vehicles = vehicles.filter(vehicle => vehicle.id !== id);
                    localStorage.setItem('workshopVehicles', JSON.stringify(vehicles));
                    updateVehiclesList();
                    showToast('Veículo excluído com sucesso!');
                }
            }

            // Funções de relatório
            function generateTextReportHandler() {
                const vehicles = JSON.parse(localStorage.getItem('workshopVehicles')) || [];
                if (vehicles.length === 0) {
                    showToast('Não há veículos para gerar relatório', 'error');
                    return;
                }
                
                let reportText = "RELATÓRIO DE VEÍCULOS - OFICINAMASTER\n";
                reportText += "==========================================\n\n";
                
                // Agrupar por status
                const statusGroups = {
                    'pending': vehicles.filter(v => v.status === 'pending'),
                    'progress': vehicles.filter(v => v.status === 'progress'),
                    'completed': vehicles.filter(v => v.status === 'completed'),
                    'delivered': vehicles.filter(v => v.status === 'delivered')
                };
                
                for (const [status, vehiclesInStatus] of Object.entries(statusGroups)) {
                    if (vehiclesInStatus.length > 0) {
                        reportText += `\n${getStatusText(status).toUpperCase()} (${vehiclesInStatus.length})\n`;
                        reportText += "".padEnd(40, "=") + "\n";
                        
                        vehiclesInStatus.forEach(vehicle => {
                            reportText += `Placa: ${vehicle.plate} | Modelo: ${vehicle.model}\n`;
                            reportText += `Proprietário: ${vehicle.owner || 'Não informado'} | Ano: ${vehicle.year || 'N/I'}\n`;
                            reportText += `Serviço: ${vehicle.service || 'Não especificado'}\n`;
                            reportText += `Entrada: ${vehicle.date} | Status: ${getStatusText(vehicle.status)}\n`;
                            if (vehicle.checked) reportText += `Conferido em: ${vehicle.checkedAt}\n`;
                            reportText += "\n";
                        });
                    }
                }
                
                // Criar e baixar o arquivo de texto
                const blob = new Blob([reportText], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `relatorio-veiculos-${new Date().toISOString().split('T')[0]}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showToast('Relatório em texto gerado com sucesso!');
            }

            function generatePdfReportHandler() {
                const { jsPDF } = window.jspdf;
                const vehicles = JSON.parse(localStorage.getItem('workshopVehicles')) || [];
                
                if (vehicles.length === 0) {
                    showToast('Não há veículos para gerar relatório', 'error');
                    return;
                }
                
                const doc = new jsPDF();
                
                // Título
                doc.setFontSize(20);
                doc.text("RELATÓRIO DE VEÍCULOS", 105, 15, { align: 'center' });
                doc.setFontSize(12);
                doc.text("OficinaMaster - " + new Date().toLocaleDateString('pt-BR'), 105, 22, { align: 'center' });
                
                // Preparar dados para a tabela
                const tableData = vehicles.map(vehicle => [
                    vehicle.plate,
                    vehicle.model,
                    vehicle.owner || 'Não informado',
                    vehicle.year || 'N/I',
                    getStatusText(vehicle.status),
                    vehicle.date
                ]);
                
                // Criar tabela
                doc.autoTable({
                    head: [['Placa', 'Modelo', 'Proprietário', 'Ano', 'Status', 'Entrada']],
                    body: tableData,
                    startY: 30,
                    theme: 'grid',
                    styles: { fontSize: 10 },
                    headStyles: { fillColor: [52, 152, 219] }
                });
                
                // Salvar PDF
                doc.save(`relatorio-veiculos-${new Date().toISOString().split('T')[0]}.pdf`);
                
                showToast('Relatório em PDF gerado com sucesso!');
            }

            // Mostrar notificação
            function showToast(message, type = 'success') {
                toast.textContent = message;
                toast.className = type === 'success' ? 'toast show' : 'toast show error';
                
                setTimeout(() => {
                    toast.classList.remove('show');
                }, 3000);
            }

            // Inicializar a lista de veículos
            updateVehiclesList();
        });
    </script>
</body>
</html>
